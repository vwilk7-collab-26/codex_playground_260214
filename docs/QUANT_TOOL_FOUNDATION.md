# Quant Tool Foundation (Draft v0.5)

## 0) 작업 원칙 (항상 문서 최상단 유지)
1. 모르는 내용은 모른다고 명시하고, 사용자와 함께 가설/검증으로 결정한다.
2. 제안/의사결정은 공식 문서 등 근거 기반으로 진행한다.
3. 문서 마지막에 근거 URL을 기록하고, 어느 섹션에서 참조했는지 함께 적는다.
4. 외부 API 연동 시 보안 설계를 기본으로 포함한다. (무료로 가능한 보안 대책 우선)
5. 반복/복붙 중심의 비효율 코딩을 피하고, 공용 모듈/재사용 구조를 우선한다.
6. 기능은 구조화해서 구현하고, 유지보수에 필요한 주석은 최소한으로 명확하게 남긴다.
7. 툴 사용 시 유료 서비스/API 비용이 발생하지 않도록 무료 범위 안에서 설계/운영한다.
8. 기능 구현은 수직 슬라이스 단위로 진행하고, 각 슬라이스는 데모 가능 상태로 완료한다.
9. 각 기능 완료 시 입력 검증/실패 케이스/로깅/최소 테스트/README·문서 업데이트를 필수로 수행한다.

---

## 1) 프로젝트 목적
목표는 "프로젝트 단위로 퀀트 분석 이력을 관리"하면서,
자연어 전략 작성 -> 백테스트 -> 비교 분석 -> 선택적 문서화까지 이어지는 개인용 툴을 만드는 것이다.

핵심 가치:
- 기능 추가가 쉬운 플러그인 구조
- 재현 가능한 백테스트 결과
- 초보 사용자도 따라가기 쉬운 프로젝트 중심 UX

---

## 2) 사용자 시나리오 (페이지 기준, 확정)
1. 첫 페이지에서 만들 기능 유형을 선택한다.
   - 예: `기술적 기반 전략 백테스터`, `글로벌 자산 영향 기반 백테스터`
2. `기술적 기반 전략 백테스터`를 선택하면 프로젝트 생성/목록 페이지로 이동한다.
3. 사용자가 `프로젝트 정의`를 누르면 제목을 입력하고, 생성 시점 타임스탬프를 내부 기록한다.
4. 프로젝트 내부에서 자연어 기반 전략 아이디어를 입력하고, 구조화 스펙을 확인/수정한 뒤 백테스트를 실행한다.
5. 프로젝트 내부에서 설정값을 바꿔 여러 번 재백테스트하고 실행 이력을 누적한다.
6. 필요할 때만 문서화 버튼으로 리포트를 생성한다.
7. 여러 프로젝트를 선택해 전략 간 비교 리포트를 생성한다.
8. 상단 우측 `저장`으로 현재 설정/선택 심볼/전략 스펙을 프로젝트에 영속 저장하고, 재진입 시 복원한다.

---

## 3) 용어 정의
- `심볼(symbol)`: 분석 대상 자산 코드. 예: `BTCUSDT`, `ETHUSDT`.
- `기간(period)`: 백테스트를 돌릴 날짜 범위. 예: `2024-01-01 ~ 2025-12-31`.
- `타임프레임(timeframe)`: 캔들 간격. 예: `5m`, `1h`, `1d`.

요청 반영:
- 심볼은 다중 선택 가능.
- 사용자가 시작일을 너무 이르게 잡아도, 각 심볼의 실제 데이터 시작 시점 이후부터 자동 계산.
- 비교 기준은 "사용자가 선택한 다중 심볼 집합"을 기준으로 자동 정렬한다.

---

## 4) 티커 선택 UX (업데이트)

### 목표
자산 이름을 입력하면, 상위 시가총액 500위권 내에서 예상 티커를 1~3개 추천하고 이미지와 함께 마우스로 선택할 수 있어야 한다.

### 동작 규칙
1. 검색어 입력 (한국어/영어 지원)
2. 시스템이 상위 500 코인 목록에서 이름/심볼 매칭
3. 결과를 1~3개 카드로 제안 (`name`, `symbol`, `market_cap_rank`, `image`)
4. 매칭이 없으면 `일치하는 코인이 없습니다` 안내
5. 사용자 마우스 클릭으로 다중 선택
6. 선택된 심볼을 백테스트 범위에 반영

### 데이터 규칙
- 우선순위는 `market_cap_rank <= 500`.
- 동명이인/심볼 중복이 있을 수 있으므로 `coin id`를 내부 키로 사용.
- 이미지 URL은 공급자 응답 필드 사용.
- 티커(symbol) 입력/저장은 영어만 허용한다.

### 언어 규칙
- 자연어 입력은 한국어/영어를 지원한다.
- 티커 입력 필드는 영어(알파벳/숫자)만 지원한다.

### UI 형식 결정
- 이 기능(이미지 + 마우스 다중선택)을 위해 MVP UI는 CLI 단독이 아니라
  "로컬 웹 UI(경량) + 코어 엔진" 구조를 채택한다.

---

## 5) 기간 선택 UX (신규)
- 기간 선택 시 30일 단위 블록을 시각화한 하단 타임라인 패널을 제공한다.
- 사용자는 블록 클릭으로 시작/종료 구간을 빠르게 선택한다.
- 수동 날짜 입력과 타임라인 클릭 방식을 동시에 지원한다.
- 선택 시작일이 심볼 상장일/데이터 시작일보다 이르면 자동으로 가능한 시작일로 보정한다.

---

## 6) 범위 정의

### Phase 1 (지금 목표)
- 암호화폐 대상
- 과거 데이터 중심
- 프로젝트 생성/조회/재실행
- 자연어 전략 입력 -> 구조화 스펙 변환
- 백테스트 결과 시각화 + 선택적 문서화

### Phase 2
- 거시지표 결합 분석(CPI, 환율, 국채수익률)
- 프로젝트 묶음 비교 리포트 고도화
- 실시간 데이터 수집 파이프라인 추가

### Phase 3
- 실거래 엔진/브로커 연동
- 자동매매 운영 및 일별 손익 자동 보고

현재 비범위:
- 초기 단계에서의 실거래 자동주문
- 초저지연(HFT) 최적화

---

## 7) 핵심 기반 기술

### A. 프로젝트/이력 관리 레이어 (최우선)
목표: "한 번 한 분석을 언제든 그대로 다시 열람/재실행"

필수 기능:
- 프로젝트 생성
- 프로젝트 메타데이터 저장(목적, 범위, 전략 초안)
- 실행 이력(run history) 저장
- 실행별 파라미터 diff 추적
- 과거 run 재열기/재실행

데이터 모델(초안):
- `Project`
- `Run`
- `StrategySpec`
- `RunResult`

### B. 데이터 레이어
- `DataProvider` 인터페이스 고정
- 무료 과거 데이터 공급자를 교체 가능한 구조로 설계
- 원본(raw)/정제(clean) 분리 저장
- 심볼별 데이터 시작일 메타 저장

### C. 분석 레이어
- 수익 전략(Alpha)과 리스크 전략(Risk) 분리
- 전략 코드는 백테스트/실거래 엔진에서 공용 사용
- 성과지표 계산: ROI, MDD, 승률, 손익분포 등

### D. 실행 레이어
- `BacktestEngine` / `LiveEngine` 분리
- 실행 모델 분리(`ExecutionModel`)
- 지연/슬리피지/수수료 반영

### E. 보고 레이어
- 툴 내부 결과 뷰 우선
- 문서화는 버튼 기반 "선택 실행"
- 포맷은 추후 확정(Excel/PDF 우선 검토)

---

## 8) 데이터 공급자 전략 (무료 고정)
- 시작: 암호화폐 + 무료 과거 데이터
- 운영 원칙: 무료 플랜/무료 API만 사용
- 전환 방식: 같은 `DataProvider` 인터페이스 내에서 무료 공급자 교체

권장 인터페이스:
- `fetch_ohlcv(symbol, timeframe, start, end)`
- `stream_ohlcv(symbol, timeframe, on_bar)`
- `get_symbol_meta(symbol)`
- `search_symbols(query, limit, rank_max)`

실무 제안:
- 공급자별 `symbol mapper`로 거래소 심볼 표기 차이를 흡수한다.
- 타임프레임 미지원 시 하위 봉 집계(예: 5m -> 10m) 규칙을 공통화한다.

---

## 9) 지연/체결 모델

MVP 기본값:
- 수수료 반영
- 고정 슬리피지(bps)
- 신호 발생 후 다음 봉 체결

확장 옵션:
- 랜덤 지연(ms 분포)
- 부분체결/미체결
- 유동성 기반 체결 제약

---

## 10) UI/조작 요구사항 (MVP)

### A. 첫 페이지 (기능 선택)
- 기능 유형 카드/목록 표시
- 사용자가 기능을 선택하면 해당 워크플로우 페이지로 이동

### B. 프로젝트 화면
- 프로젝트 목록
- `프로젝트 정의` 버튼 제공
- 프로젝트 상세(제목, 생성 시점, 목적, 범위, 전략, 실행 이력)
- 상단 우측 `저장` 버튼으로 현재 프로젝트 상태 영속 저장
- run 선택 시 설정값/결과/로그 확인

### C. 프로젝트 정의/전략 입력/백테스트 화면
- 자연어 입력(한국어/영어): 수익 아이디어, 리스크 아이디어
- 에이전트가 전략 해석 요약을 먼저 제시
- 에이전트가 부족한 조건(진입/청산/손절/수수료/슬리피지 등)을 질문/제안
- 사용자가 수정/확정하면 구조화 스펙 미리보기/수정
- 심볼 검색 자동완성(1~3 제안) + 이미지 + 다중 선택
- 기간 선택: 30일 단위 시각 타임라인 + 수동 입력
- `백테스팅 실행` 버튼
- 실행 후 일부 설정값 수정 -> 재실행 가능
- 오른쪽 패널에 차트/지표/매수·매도 포인트를 범례와 색상으로 시각화
- 사용자가 `OK`로 전략 시각화를 확인한 후 백테스트 실행 가능

### D. 결과 표시 규칙
- 자산별, 타임프레임별, 전략별 표를 한 화면에서 비교
- 색상 규칙(요청 반영):
  - 수익: Red
  - 손실: Blue

### E. 문서화 트리거
- 결과를 본 뒤 사용자가 `문서화` 버튼을 눌렀을 때만 리포트 생성
- 자동 문서화는 기본값 비활성
- Excel/PDF 리포트에는 차트/지표/매수·매도 포인트를 범례와 색상으로 포함
- 리포트 설명 문구는 한국어로 작성

---

## 11) MVP 재정의 (v0.5)
MVP 핵심은 "자연어 전략을 프로젝트 단위로 반복 실험하고, 필요할 때만 문서화"이다.

필수 완료 조건:
1. 프로젝트 생성/조회/재진입
2. 프로젝트 내 다회 백테스트 실행
3. 이름 기반 심볼 추천(상위 500, 1~3 제안, 이미지, no-match 안내, 다중선택)
4. 한국어/영어 자연어 입력 지원 + 티커 영어 입력 제한
5. 기간 30일 단위 시각 타임라인 선택
6. 데이터 가용 시작일 자동 보정
7. 전략 해석 요약/보완 제안 에이전트 + 차트 확인 `OK` 단계
8. 결과 비교표와 색상 규칙 적용
9. 문서화 버튼 기반 리포트 생성 트리거(Excel/PDF 한글 설명 포함)
10. 상단 우측 저장으로 프로젝트 상태 영속화/재복원

MVP는 실행 시간 SLA를 고정하지 않는다.

---

## 12) 보안 설계 원칙 (무료 중심)
1. API 키 보관: `.env` + 로컬 키체인 사용, 코드/문서에 하드코딩 금지
2. 입력 검증: 심볼/기간/타임프레임 화이트리스트 검증
3. 호출 제한: 공급자 rate limit 대응(백오프/재시도)
4. 의존성 점검: `pip-audit`를 CI 또는 로컬 점검 루틴에 포함
5. 로그 최소화: 민감 정보(API 키, 계정 식별자) 마스킹
6. 외부 API 응답 신뢰 금지: 스키마 검증 후 저장

---

## 13) 플러그인 가능한 코드 구조 (업데이트)

```text
quant_tool/
  core/
    config.py
    registry.py
    types.py

  projects/
    models.py
    repository.py
    service.py

  data/
    providers/
      base.py
      free_crypto.py
      free_crypto_alt.py
    ingestion/
      pipeline.py
    storage/
      candles_repo.py
      symbol_meta_repo.py

  strategy/
    alpha/
      base.py
      rsi_alpha.py
    risk/
      base.py
      mdd_guard.py
    nl/
      parser.py

  execution/
    backtest_engine.py
    live_engine.py
    models/
      simulated_execution.py
      live_execution.py

  app/
    view_models.py
    actions.py
    symbol_picker.py
    period_timeline.py
    chart_preview.py
    project_save.py

  agent/
    strategy_interpreter.py # 자연어 전략 요약/질문/보완 제안

  reporting/
    exporters/
      excel_exporter.py
      pdf_exporter.py
```

---

## 14) 다음 결정 항목
1. 프로젝트 저장 방식: SQLite + 파일 리포트로 확정할지
2. 자연어 전략 스펙 포맷: YAML vs JSON
3. 로컬 웹 UI 프레임워크: Streamlit vs FastAPI+React(경량)
4. 차트 렌더러: Plotly vs Lightweight Charts

---

## 15) 근거 URL 및 참조 위치
1. CoinGecko `/coins/markets` (image, market_cap_rank, per_page/page)
- URL: https://docs.coingecko.com/reference/coins-markets
- 참조 섹션: `4) 티커 선택 UX`, `8) 데이터 공급자 전략`

2. CoinGecko `/coins/list` (id/name/symbol 매핑)
- URL: https://docs.coingecko.com/reference/coins-list
- 참조 섹션: `4) 티커 선택 UX` (내부 키를 `coin id`로 사용하는 근거)

3. CoinGecko API 무료/데모 rate limit 관련
- URL: https://support.coingecko.com/hc/en-us/articles/4538771776153-What-is-the-rate-limit-for-CoinGecko-API-public-plan
- URL: https://www.coingecko.com/en/api
- 참조 섹션: `8) 데이터 공급자 전략`, `12) 보안 설계 원칙`

4. OWASP API Security Top 10 (API 보안 기준)
- URL: https://owasp.org/API-Security/editions/2023/en/0x11-t10/
- 참조 섹션: `12) 보안 설계 원칙`

5. pip-audit (Python 의존성 취약점 점검)
- URL: https://pypi.org/project/pip-audit/
- 참조 섹션: `12) 보안 설계 원칙`
